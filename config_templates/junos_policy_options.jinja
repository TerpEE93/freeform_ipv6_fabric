{#
    Much of this is boilerplate, but we do need to generate policies
    per Tenant
#}
{% set routing_instances = property_sets.get('vrf_vlan', {}).itervalues()|list %}
replace: policy-options {
    policy-statement AllPodNetworks {
        term AllPodNetworks-10 {
            from {
                family inet;
                protocol direct;
            }
            then {
                community add DEFAULT_DIRECT_V4;
                accept;
            }
        }
        term AllPodNetworks-20 {
            from {
                family inet6;
                protocol direct;
            }
            then {
                community add DEFAULT_DIRECT_V6;
                accept;
            }
        }
        term AllPodNetworks-100 {
            then reject;
        }
    }
    policy-statement BGP-AOS-Policy {
        term BGP-AOS-Policy-10 {
            from policy AllPodNetworks;
            then accept;
        }
        term BGP-AOS-Policy-20 {
            from {
                protocol bgp;
            }
            then accept;
        }
        term BGP-AOS-Policy-100 {
            then reject;
        }
    }
    policy-statement EVPN_EXPORT {
        term EVPN_EXPORT-4095 {
            then accept;
        }
    }
    policy-statement LEAF_TO_SPINE_EVPN_OUT {
        term LEAF_TO_SPINE_EVPN_OUT-10 {
            from {
                protocol bgp;
                community FROM_SPINE_EVPN_TIER;
            }
            then reject;
        }
        term LEAF_TO_SPINE_EVPN_OUT-20 {
            then accept;
        }
    }
    policy-statement LEAF_TO_SPINE_FABRIC_OUT {
        term LEAF_TO_SPINE_FABRIC_OUT-10 {
            from {
                protocol bgp;
                community FROM_SPINE_FABRIC_TIER;
            }
            then reject;
        }
        term LEAF_TO_SPINE_FABRIC_OUT-20 {
            then accept;
        }
    }
    policy-statement SPINE_TO_LEAF_EVPN_OUT {
        term SPINE_TO_LEAF_EVPN_OUT-10 {
            then {
                community add FROM_SPINE_EVPN_TIER;
                accept;
            }
        }
    }
    policy-statement SPINE_TO_LEAF_FABRIC_OUT {
        term SPINE_TO_LEAF_FABRIC_OUT-10 {
            then {
                community add FROM_SPINE_FABRIC_TIER;
                accept;
            }
        }
    }
    policy-statement PFE-LB {
        then {
            load-balance per-packet;
        }
    }
{% for ri in routing_instances %}
    {% if ri.vrf_name %}
    policy-statement AllPodNetworks-{{ ri.vrf_name }} {
        term AllPodNetworks-{{ ri.vrf_name }}-10 {
            from {
                family inet;
                protocol [ direct static ];
            }
            then {
                community add {{ ri.vrf_name }}_COMMUNITY_V4;
                accept;
            }
        }
        term AllPodNetworks-{{ ri.vrf_name }}-20 {
            from {
                family inet6;
                protocol [ direct static ];
            }
            then {
                community add {{ ri.vrf_name }}_COMMUNITY_V6;
                accept;
            }
        }
        term AllPodNetworks-{{ ri.vrf_name }}-100 {
            then reject;
        }
    }
    policy-statement BGP-AOS-Policy-{{ ri.vrf_name }} {
        term BGP-AOS-Policy-{{ ri.vrf_name }}-10 {
            from {
                policy AllPodNetworks-{{ ri.vrf_name }};
            }
            then accept;
        }
        term BGP-AOS-Policy-{{ ri.vrf_name }}-50 {
            from {
                protocol evpn;
                route-filter 0.0.0.0/0 prefix-length-range /32-/32;
            }
            then {
                community add {{ ri.vrf_name }}_COMMUNITY_V4;
                accept;
            }
        }
        term BGP-AOS-Policy-{{ ri.vrf_name }}-60 {
            from {
                protocol evpn;
                route-filter 0::0/0 prefix-length-range /128-/128;
            }
            then {
                community add {{ ri.vrf_name }}_COMMUNITY_V6;
                accept;
            }
        }
        term BGP-AOS-Policy-{{ ri.vrf_name }}-70 {
            from protocol ospf;
            then {
                community add {{ ri.vrf_name }}_COMMUNITY_V4;
                accept;
            }
        }
        term BGP-AOS-Policy-{{ ri.vrf_name }}-80 {
            from protocol ospf3;
            then {
                community add {{ ri.vrf_name }}_COMMUNITY_V6;
                accept;
            }
        }
        term BGP-AOS-Policy-{{ ri.vrf_name }}-100 {
            then reject;
        }
    }
    {% endif %}
{% endfor %}
    community DEFAULT_DIRECT_V4 members [ 3:20007 21001:26000 ];
    community DEFAULT_DIRECT_V6 members [ 3:20008 21001:26000 ];
    community FROM_SPINE_EVPN_TIER members 0:14;
    community FROM_SPINE_FABRIC_TIER members 0:15;
{% for ri in routing_instances %}
    {% if ri.vrf_name and ri.tenant_vni %}
    community {{ ri.vrf_name }}_COMMUNITY_V4 members [ 3:20007 {{ ri.tenant_vni }}:26000 ];
    community {{ ri.vrf_name }}_COMMUNITY_V6 members [ 3:20008 {{ ri.tenant_vni }}:26000 ];  
    {% endif %}
{% endfor %}
}
{# EOF #}