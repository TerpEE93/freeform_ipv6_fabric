{
  "label": "junos_policy_options.jinja",
  "text": "{% set sys_prop = property_sets.get('custom_sys_properties', {} ) %}\n{% set prot_prop = property_sets.get('protocol_properties', {}) %}\n{% set vrf_vlan = property_sets.get('vrf_vlan', {}) %}\n{% set ns = namespace( ) %}\n{% set ns.ri_w_bgp = [] %}\n{% set ns.ri_w_ospf = [] %}\n{% set ns.ri_w_static = [] %}\n{% set ns.mgt4_allowed = [ ] %}\n{% set ns.mgt6_allowed = [ ] %}\n{% set ns.bgp_peer6 = [ ] %}\n{% for ri in vrf_vlan.vrfs %}\n    {% set ns.is_bgp = false %}\n    {% set ns.is_ospf = false %}\n    {% set ns.is_static = false %}\n    {% for vlan in vrf_vlan.vlans %}\n        {% if vlan['is_bgp'] %}{{ ns.ri_w_bgp.append( ri['vrf_name'] ) or '' }}{%- endif %}\n        {% if vlan['is_ospf'] %}{{ ns.ri_w_ospf.append( ri['vrf_name'] ) or '' }}{%- endif %}\n        {% if vlan['is_static'] %}{{ ns.ri_w_static.append( ri['vrf_name'] ) or '' }}{%- endif %}\n    {% endfor %}\n{% endfor %}\n{% set is_border = false %}\n{% if 'gateway_A' in system_tags or 'gateway_B' in system_tags %}\n    {% set is_border = true %}\n{% endif %}\n{# Stuff we need for a Protect-RE filter #}\n{% if 'protect_re' in sys_prop and sys_prop.protect_re.enabled %}\n    {# Create allowed prefix lists for v4 and v6 #}\n    {% if 'mgt_allowed_v4' in sys_prop.protect_re %}\n        {% for prefix in sys_prop.protect_re.mgt_allowed_v4 %}\n            {{ ns.mgt4_allowed.append(prefix) or '' }}\n        {%- endfor %}\n    {% endif %}\n    {% if 'mgt_allowed_v6' in sys_prop.protect_re %}\n        {% for prefix in sys_prop.protect_re.mgt_allowed_v6 %}\n            {{ ns.mgt6_allowed.append(prefix) or '' }}\n        {%- endfor %}\n    {% endif %}\n    {# Determine addresses of BGP peers for family inet/inet6 #}\n    {% for interface_name, iface in interfaces.iteritems() %}\n        {% if iface.get('ipv6_address') %}\n            {% set neighbor_interfaces = iface.get('neighbor_interfaces', []) %}\n            {% for neighbor_interface in neighbor_interfaces %}\n                {% if neighbor_interface.get('ipv6_address') %}\n                    {{ ns.bgp_peer6.append(neighbor_interface.ipv6_address) or '' }}\n                {%- endif %}\n            {% endfor %}\n        {% endif %}\n    {% endfor %}\n    {# Only leaf devices will have peers for family evpn-sgnaling #}\n    {% if 'leaf' in system_tags %}\n        {% for interface_name, iface in interfaces.iteritems() %}\n            {% if iface.get('ipv6_address') %}\n                {% set neighbor_interfaces = iface.get('neighbor_interfaces', []) %}\n                {% for neighbor_interface in neighbor_interfaces %}\n        \t\t    {% set ns.neighbor_loopback = function.get_resource_value(all_resources.get(neighbor_interface.system_id),\n                        'loopback_assignments', 'fabric_resources', 'devices') %}\n                    {% if ns.neighbor_loopback|to_netmask == 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff'\n                        or ns.neighbor_loopback|to_netmask == 'ffff:ffff:ffff:ffff:ffff:ffff:ffff:fffe' %}\n                        {% set peer_ipv6 = ns.neighbor_loopback|to_ip %}\n                    {% else %}\n                        {% set peer_ipv6 = ns.neighbor_loopback|replace( '::/', '::1/' )|to_ip %}\n                    {% endif %}\n                    {{ ns.bgp_peer6.append(peer_ipv6) or '' }}\n                {% endfor %}\n            {% endif %}\n        {% endfor %}\n    {% endif %}\n{% endif %}\n{# Done Protect-RE #}\nreplace: policy-options {\n{% if is_border %}\n    {% for ri in vrf_vlan.vrfs %}\n        {% if ri['vrf_name'] %}\n    route-filter-list RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable{\n        0.0.0.0/0 upto /32;\n    }\n    route-filter-list RoutesFromExtV6-{{ ri['vrf_name'] }}-Default_immutable{\n        0::0/0 upto /128;\n    }\n    route-filter-list RoutesToExt-{{ ri['vrf_name'] }}-Default_immutable {\n            {% for vlan in vrf_vlan.vlans %}\n                {% if vlan['irb_gateway4'] != '' %}\n                    {% set irb_prefix = [ vlan['irb_gateway4'], vlan['ipv4_prefix_len'] ]|join('/')|to_network %}\n                    {{ irb_prefix }}/{{ vlan['ipv4_prefix_len'] }} upto /32;\n                {% endif %}\n            {% endfor %}\n    }\n    route-filter-list RoutesToExtV6-{{ ri['vrf_name'] }}-Default_immutable {\n            {% for vlan in vrf_vlan.vlans %}\n                {% if vlan['irb_gateway6'] != '' %}\n                    {% set irb_prefix = [ vlan['irb_gateway6'], vlan['ipv6_prefix_len'] ]|join('/')|to_network %}\n                    {{ irb_prefix }}/{{ vlan['ipv6_prefix_len'] }} upto /128;\n                {% endif %}\n            {% endfor %}\n    }\n        {% endif %}\n    {% endfor %}\n{% endif %}\n{% if ns.mgt4_allowed != [ ] %}\n    prefix-list MGT_SUBNETS_v4 {\n        {% for prefix in ns.mgt4_allowed %}\n        {{ prefix }};\n        {% endfor %}\n    }\n{% endif %}\n{% if ns.mgt6_allowed != [ ] %}\n    prefix-list MGT_SUBNETS_v6 {\n        {% for prefix in ns.mgt6_allowed %}\n        {{ prefix }};\n        {% endfor %}\n    }\n{% endif %}\n{% if ns.bgp_peer6 != [ ] %}\n    prefix-list BGP_PEERS_v6 {\n        {% for prefix in ns.bgp_peer6 %}\n        {{ prefix }};\n        {% endfor %}\n    }\n{% endif %}\n    policy-statement AllPodNetworks {\n        term AllPodNetworks-10 {\n            from {\n                family inet;\n                protocol direct;\n            }\n            then {\n                community add DEFAULT_DIRECT_V4;\n                accept;\n            }\n        }\n        term AllPodNetworks-20 {\n            from {\n                family inet6;\n                protocol direct;\n            }\n            then {\n                community add DEFAULT_DIRECT_V6;\n                accept;\n            }\n        }\n        term AllPodNetworks-100 {\n            then reject;\n        }\n    }\n    policy-statement BGP-AOS-Policy {\n        term BGP-AOS-Policy-10 {\n            from policy AllPodNetworks;\n            then accept;\n        }\n        term BGP-AOS-Policy-20 {\n            from {\n                protocol bgp;\n            }\n            then accept;\n        }\n{% if ns.ri_w_bgp != '' %}\n        term BGP-AOS-Policy-50 {\n            from {\n                protocol evpn;\n                route-filter 0.0.0.0/0 prefix-length-range /32-/32;\n            }\n            then accept;\n        }\n        term BGP-AOS-Policy-60 {\n            from {\n                protocol evpn;\n                route-filter 0::0/0 prefix-length-range /128-/128;\n            }\n            then accept;\n        }\n{% endif %}\n        term BGP-AOS-Policy-100 {\n            then reject;\n        }\n    }\n    policy-statement EVPN_EXPORT {\n        term EVPN_EXPORT-4095 {\n            then accept;\n        }\n    }\n    policy-statement LEAF_TO_SPINE_EVPN_OUT {\n        term LEAF_TO_SPINE_EVPN_OUT-10 {\n            from {\n                protocol bgp;\n                community FROM_SPINE_EVPN_TIER;\n            }\n            then reject;\n        }\n        term LEAF_TO_SPINE_EVPN_OUT-20 {\n            then accept;\n        }\n    }\n{% if 'leaf' in system_tags %}\n    policy-statement LEAF_TO_SPINE_FABRIC_OUT {\n        term LEAF_TO_SPINE_FABRIC_OUT-10 {\n            from {\n                protocol bgp;\n                community FROM_SPINE_FABRIC_TIER;\n            }\n            then reject;\n        }\n        term LEAF_TO_SPINE_FABRIC_OUT-20 {\n            then accept;\n        }\n    }\n    {% for ri in vrf_vlan.vrfs %}\n        {% if ri['vrf_name'] %}\n    policy-statement AllPodNetworks-{{ ri['vrf_name'] }} {\n        term AllPodNetworks-{{ ri['vrf_name'] }}-10 {\n            from {\n                family inet;\n                protocol [ direct {% if ri['vrf_name'] in ns.ri_w_static %}static {% endif %}];\n            }\n            then {\n                community add {{ ri['vrf_name'] }}_COMMUNITY_V4;\n                accept;\n            }\n        }\n        term AllPodNetworks-{{ ri['vrf_name'] }}-20 {\n            from {\n                family inet6;\n                protocol [ direct {% if ri['vrf_name'] in ns.ri_w_static %}static {% endif %}];\n            }\n            then {\n                community add {{ ri['vrf_name'] }}_COMMUNITY_V6;\n                accept;\n            }\n        }\n        term AllPodNetworks-{{ ri['vrf_name'] }}-100 {\n            then reject;\n        }\n    }\n    policy-statement BGP-AOS-Policy-{{ ri['vrf_name'] }} {\n        term BGP-AOS-Policy-{{ ri['vrf_name'] }}-10 {\n            from {\n                policy AllPodNetworks-{{ ri['vrf_name'] }};\n            }\n            then accept;\n        }\n            {% if is_border and ri['vrf_name'] in ns.ri_w_bgp %}\n        term BGP-AOS-Policy-{{ ri['vrf_name'] }}-20 {\n            from protocol bgp;\n            then accept;\n        }\n            {% endif %}\n        term BGP-AOS-Policy-{{ ri['vrf_name'] }}-50 {\n            from {\n                protocol evpn;\n                route-filter 0.0.0.0/0 prefix-length-range /32-/32;\n            }\n            then {\n                community add {{ ri['vrf_name'] }}_COMMUNITY_V4;\n                accept;\n            }\n        }\n        term BGP-AOS-Policy-{{ ri['vrf_name'] }}-60 {\n            from {\n                protocol evpn;\n                route-filter 0::0/0 prefix-length-range /128-/128;\n            }\n            then {\n                community add {{ ri['vrf_name'] }}_COMMUNITY_V6;\n                accept;\n            }\n        }\n            {% if is_border and ri['vrf_name'] in ns.ri_w_ospf %}\n        term BGP-AOS-Policy-{{ ri['vrf_name'] }}-70 {\n            from protocol ospf;\n            then {\n                community add {{ ri['vrf_name'] }}_COMMUNITY_V4;\n                accept;\n            }\n        }\n        term BGP-AOS-Policy-{{ ri['vrf_name'] }}-80 {\n            from protocol ospf3;\n            then {\n                community add {{ ri['vrf_name'] }}_COMMUNITY_V6;\n                accept;\n            }\n        }\n            {% endif %}\n        term BGP-AOS-Policy-{{ ri['vrf_name'] }}-100 {\n            then reject;\n        }\n    }\n            {% if is_border %}\n    policy-statement RoutesToExt-{{ ri['vrf_name'] }}-Default_immutable {\n        term RoutesToExt-{{ ri['vrf_name'] }}-Default_immutable-10 {\n            from {\n                family inet;\n                route-filter-list RoutesToExt-{{ ri['vrf_name'] }}-Default_immutable;\n            }\n            then {\n                community delete FABRIC_COMMUNITIES;\n                accept;\n            }\n        }\n        term RoutesToExt-{{ ri['vrf_name'] }}-Default_immutable-20 {\n            from {\n                family inet6;\n                route-filter-list RoutesToExtV6-{{ ri['vrf_name'] }}-Default_immutable;\n            }\n            then {\n                community delete FABRIC_COMMUNITIES;\n                accept;\n            }\n        }\n        term RoutesToExt-{{ ri['vrf_name'] }}-Default_immutable-30 {\n            from family inet;\n            then reject;\n        }\n        term RoutesToExt-{{ ri['vrf_name'] }}-Default_immutable-40 {\n            from family inet6;\n            then reject;\n        }\n    }\n    policy-statement RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable {\n        term RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable-10 {\n            from {\n                family inet;\n                route-filter-list RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable;\n            }\n            then {\n                community add RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable;\n                accept;\n            }\n        }\n        term RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable-20 {\n            from {\n                family inet6;\n                route-filter-list RoutesFromExtV6-{{ ri['vrf_name'] }}-Default_immutable;\n            }\n            then {\n                community delete RoutesFromExtV6-{{ ri['vrf_name'] }}-Default_immutable;\n                accept;\n            }\n        }\n        term RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable-30 {\n            from family inet;\n            then reject;\n        }\n        term RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable-40 {\n            from family inet6;\n            then reject;\n        }\n    }\n    policy-statement AOS-EXPORT-OSPF {\n        term AOS-EXPORT-OSPF-10 {\n            from {\n                family inet;\n                protocol [ direct aggregate ];\n            }\n            then {\n                tag {{ prot_prop.ospf.tag_v4 }};\n                accept;\n            }\n        }\n        term AOS-EXPORT-OSPF-20 {\n            from {\n                family inet6;\n                protocol [ direct aggregate ];\n            }\n            then {\n                tag {{ prot_prop.ospf.tag_v6 }};\n                accept;\n            }\n        }\n        term AOS-EXPORT-OSPF-100 {\n            then reject;\n        }\n    }\n    policy-statement AOS-IMPORT-OSPF {\n        term AOS-IMPORT-OSPF-10 {\n            from tag [ {{ prot_prop.ospf.tag_v4 }} {{ prot_prop.ospf.tag_v6 }} ];\n            then reject;\n        }\n        term AOS-IMPORT-OSPF-100 {\n            then accept;\n        }\n    }\n            {% endif %}\n        {% endif %}\n    {% endfor %}\n{% endif %}\n{% if 'spine' in system_tags %}\n    policy-statement SPINE_TO_LEAF_EVPN_OUT {\n        term SPINE_TO_LEAF_EVPN_OUT-10 {\n            then {\n                community add FROM_SPINE_EVPN_TIER;\n                accept;\n            }\n        }\n    }\n    policy-statement SPINE_TO_LEAF_FABRIC_OUT {\n        term SPINE_TO_LEAF_FABRIC_OUT-10 {\n            then {\n                community add FROM_SPINE_FABRIC_TIER;\n                accept;\n            }\n        }\n    }\n{% endif %}\n    policy-statement PFE-LB {\n        then {\n            load-balance per-packet;\n        }\n    }\n    community DEFAULT_DIRECT_V4 members [ 3:20007 21001:26000 ];\n    community DEFAULT_DIRECT_V6 members [ 3:20008 21001:26000 ];\n    community FROM_SPINE_EVPN_TIER members [ 0:14 ];\n    community FROM_SPINE_FABRIC_TIER members [ 0:15 ];\n{% if is_border %}\n    community FABRIC_COMMUNITIES members [ 0:12 0:13 0:14 0:15 .+:200.. 2....:260.. 9...:260.. ];\n{% endif %}\n{% for ri in vrf_vlan.vrfs %}\n    {% if ri['vrf_name'] and ri['vrf_vni'] %}\n    community {{ ri['vrf_name'] }}_COMMUNITY_V4 members [ 3:20007 {{ ri['vrf_vni'] }}:26000 ];\n    community {{ ri['vrf_name'] }}_COMMUNITY_V6 members [ 3:20008 {{ ri['vrf_vni'] }}:26000 ];\n        {% if is_border %}\n    community RoutesFromExt-{{ ri['vrf_name'] }}-Default_immutable members [ 5:20009 {{ ri['vrf_vni'] }}:26000 ];\n    community RoutesFromExtV6-{{ ri['vrf_name'] }}-Default_immutable members [ 5:20010 {{ ri['vrf_vni'] }}:26000 ];\n        {% endif %}\n    {% endif %}\n{% endfor %}\n}\n{# EOF #}"
}